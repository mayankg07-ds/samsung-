{% extends "base.html" %}
{% block title %}EduPath AI – Dashboard{% endblock %}
{% block header_title %}Analytics Dashboard{% endblock %}

{% block content %}

<!-- ── Summary cards ──────────────────────────────────────────────────── -->
<div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-10">
    <div class="bg-gradient-to-br from-purple-800 to-purple-900 rounded-2xl p-6 shadow-xl">
        <p class="text-sm text-purple-300 mb-1">Total Courses</p>
        <p id="total-courses" class="text-4xl font-extrabold">–</p>
    </div>
    <div class="bg-gradient-to-br from-cyan-800 to-cyan-900 rounded-2xl p-6 shadow-xl">
        <p class="text-sm text-cyan-300 mb-1">Average Rating</p>
        <p id="avg-rating" class="text-4xl font-extrabold">–</p>
        <p class="text-xl mt-1">⭐</p>
    </div>
    <div class="bg-gradient-to-br from-pink-800 to-pink-900 rounded-2xl p-6 shadow-xl">
        <p class="text-sm text-pink-300 mb-1">Most Popular Category</p>
        <p id="popular-category" class="text-2xl font-extrabold">–</p>
    </div>
</div>

<!-- ── Chart grid ──────────────────────────────────────────────────────── -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

    <!-- Chart 1: Courses per Category -->
    <div class="bg-gray-800 rounded-2xl p-6 shadow-xl">
        <h3 class="text-lg font-bold mb-4">Courses per Category</h3>
        <canvas id="categoryChart" height="250"></canvas>
    </div>

    <!-- Chart 2: Difficulty Distribution -->
    <div class="bg-gray-800 rounded-2xl p-6 shadow-xl">
        <h3 class="text-lg font-bold mb-4">Difficulty Distribution</h3>
        <canvas id="difficultyChart" height="250"></canvas>
    </div>

    <!-- Chart 3: Top 10 Rated Courses -->
    <div class="bg-gray-800 rounded-2xl p-6 shadow-xl lg:col-span-2">
        <h3 class="text-lg font-bold mb-4">Top 10 Rated Courses</h3>
        <canvas id="topRatedChart" height="200"></canvas>
    </div>

    <!-- Chart 4: Avg Hours by Difficulty -->
    <div class="bg-gray-800 rounded-2xl p-6 shadow-xl lg:col-span-2">
        <h3 class="text-lg font-bold mb-4">Average Hours by Difficulty</h3>
        <canvas id="hoursChart" height="180"></canvas>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
Chart.defaults.color = '#9ca3af';
Chart.defaults.borderColor = '#374151';

const PALETTE = [
    '#8b5cf6','#06b6d4','#ec4899','#f59e0b',
    '#10b981','#3b82f6','#f97316','#6366f1',
    '#14b8a6','#e11d48'
];

async function loadDashboard() {
    const res = await fetch('/api/stats');
    const json = await res.json();
    const d = json.data;

    document.getElementById('total-courses').textContent = d.total_courses;
    document.getElementById('avg-rating').textContent = d.avg_rating.toFixed(1);
    document.getElementById('popular-category').textContent = d.most_popular_category;

    // ── Chart 1: Doughnut ─────────────────────────────────────────────
    new Chart(document.getElementById('categoryChart'), {
        type: 'doughnut',
        data: {
            labels: Object.keys(d.courses_per_category),
            datasets: [{
                data: Object.values(d.courses_per_category),
                backgroundColor: PALETTE,
                borderWidth: 2,
                borderColor: '#1f2937'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'right', labels: { boxWidth: 12, padding: 10, font: { size: 11 } } }
            }
        }
    });

    // ── Chart 2: Bar – difficulty ──────────────────────────────────────
    const diffKeys = Object.keys(d.difficulty_distribution);
    new Chart(document.getElementById('difficultyChart'), {
        type: 'bar',
        data: {
            labels: diffKeys,
            datasets: [{
                label: 'Courses',
                data: Object.values(d.difficulty_distribution),
                backgroundColor: ['#10b981','#f59e0b','#ef4444'],
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });

    // ── Chart 3: Horizontal bar – top rated ───────────────────────────
    const topRated = d.top_rated_courses;
    new Chart(document.getElementById('topRatedChart'), {
        type: 'bar',
        data: {
            labels: topRated.map(c => c.course_title.length > 35 ? c.course_title.substring(0, 32) + '…' : c.course_title),
            datasets: [{
                label: 'Rating',
                data: topRated.map(c => c.course_rating),
                backgroundColor: '#8b5cf6',
                borderRadius: 4
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { x: { min: 3, max: 5 } }
        }
    });

    // ── Chart 4: Bar – avg hours ──────────────────────────────────────
    new Chart(document.getElementById('hoursChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(d.avg_hours_by_difficulty),
            datasets: [{
                label: 'Average Hours',
                data: Object.values(d.avg_hours_by_difficulty),
                backgroundColor: '#06b6d4',
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: { callbacks: { label: ctx => ctx.parsed.y + ' hrs' } }
            },
            scales: { y: { beginAtZero: true } }
        }
    });
}

window.addEventListener('DOMContentLoaded', loadDashboard);
</script>
{% endblock %}
